# 專案開發過程報告

## 專案名稱: 圖像自動化預處理流程

## 日期: 2025年6月13日

## 1. 專案目標

本專案旨在開發一個自動化的圖像預處理流程，主要針對動漫風格圖像，為後續的 AI 模型訓練提供標準化、高品質的資料集。主要功能包括圖像驗證、人臉偵測、圖像去重、圖像裁切與分類、圖像放大以及自動標記。

## 2. 已完成子任務

### 2.1. 環境設定與依賴管理
    - **描述**: 初始化專案結構，建立 `requirements.txt` 檔案，管理 Python 依賴。
    - **完成情況**: 已完成。
    - **遇到問題與解決方案**:
        - 問題: 部分依賴包版本衝突。
        - 解決方案: 仔細調整 `requirements.txt` 中的版本號，或尋找相容版本。`pip-deepfreeze` 或 `poetry` 等工具未來可考慮用於更嚴格的依賴管理。

### 2.2. 圖像驗證模組 (`validate_image.py`)
    - **描述**: 實現圖像檔案完整性檢查，移除損壞檔案。
    - **完成情況**: 已完成。
    - **遇到問題與解決方案**:
        - 問題: 如何高效判斷圖像是否損壞而不僅僅是無法開啟。
        - 解決方案: 目前主要依賴 `Pillow` 庫的 `Image.open()` 和 `Image.verify()`。對於更深層次的損壞檢測，可能需要更專業的工具或方法。

### 2.3. 人臉偵測模組 (`face_detection.py`)
    - **描述**: 整合人臉偵測模型，篩選含有人臉的圖像，並可根據人臉數量進行過濾。
    - **完成情況**: 已完成。
    - **遇到問題與解決方案**:
        - 問題: 選擇合適的人臉偵測模型，兼顧準確度和速度。
        - 解決方案: 目前推測使用 ONNX 格式的模型，具體模型選擇依賴 `waifuc` 或 `imgutils` 內部實現或使用者配置。效能瓶頸可能出現在大量圖像處理時，考慮批次處理或非同步處理。

### 2.4. 圖像去重複模組 (`lpips_clustering.py`)
    - **描述**: 使用 LPIPS 演算法計算圖像相似度，並進行聚類以去除重複圖像。
    - **完成情況**: 已完成。
    - **遇到問題與解決方案**:
        - 問題: LPIPS 計算相對耗時，尤其對於大資料集。
        - 解決方案: 實現了批次處理 (`lpips_batch_size`)。未來可考慮：1. 初步使用更快的哈希演算法（如 pHash）進行粗篩選；2. 針對 GPU 優化 LPIPS 計算。
        - 問題: 相似度閾值的設定對去重效果影響大。
        - 解決方案: 目前閾值可能硬編碼或依賴 `waifuc` 內部設定，未來可考慮讓使用者配置。

### 2.5. 圖像裁切與分類模組 (`crop.py`)
    - **描述**: 根據人臉位置或其他特徵將圖像裁切成不同規格（全身、半身、頭像），並分類儲存。
    - **完成情況**: 已完成。
    - **遇到問題與解決方案**:
        - 問題: 裁切邏輯的通用性和準確性，特別是對於不同姿態和構圖的圖像。
        - 解決方案: 依賴 `waifuc` 庫的裁切能力，其內部可能包含複雜的啟發式規則或模型。分類邏輯目前基於檔名或預設規則。

### 2.6. 圖像放大模組 (`upscale.py`)
    - **描述**: 整合超解析度模型，放大低解析度圖像。
    - **完成情況**: 已完成。
    - **遇到問題與解決方案**:
        - 問題: 超解析度處理非常耗時耗資源。
        - 解決方案: 允許使用者選擇模型，並設定 `min_size` 以跳過已足夠大的圖像。未來可考慮支援更多模型和硬體加速選項。

### 2.7. 圖像標記模組 (`tag.py`)
    - **描述**: 自動為圖像生成描述性標籤。
    - **完成情況**: 已完成。
    - **遇到問題與解決方案**:
        - 問題: 標籤的準確性和覆蓋範圍。
        - 解決方案: 依賴 `waifuc` 庫的標記功能，其可能使用如 DeepDanbooru 等預訓練模型。標籤品質直接影響後續模型訓練效果。

### 2.8. 主流程控制與配置 (`main.py`, `.env`)
    - **描述**: 建立主執行腳本，透過 `.env` 檔案管理各模組的啟用和參數配置。
    - **完成情況**: 已完成。
    - **遇到問題與解決方案**:
        - 問題: 環境變數管理和類型轉換。
        - 解決方案: 使用 `python-dotenv` 讀取設定，並在程式碼中進行 notwendige 類型轉換和預設值處理。

### 2.10. 詳細日誌系統 (`logger_config.py`)
    - **描述**: 實現了完整的日誌記錄系統，提供結構化的日誌輸出和檔案記錄功能。
    - **完成情況**: 已完成。
    - **已實現的功能**:
        - **日誌配置模組**: 建立了 `logger_config.py` 模組，提供統一的日誌配置和管理。
        - **多級別日誌**: 支援 DEBUG、INFO、WARNING、ERROR、CRITICAL 等不同級別的日誌記錄。
        - **雙重輸出**: 同時支援控制台輸出和檔案輸出，檔案按日期和模組分類。
        - **錯誤專用日誌**: 為 ERROR 和 CRITICAL 級別的日誌建立專用檔案。
        - **環境變數控制**: 透過 `.env` 檔案可配置日誌級別、輸出方式、目錄位置和格式。
        - **全面整合**: 已整合到 `main.py` 和 `gradio_app.py` 中，為所有主要操作提供詳細的日誌記錄。
    - **遇到問題與解決方案**:
        - 問題: 如何在不同模組間統一日誌格式和配置。
        - 解決方案: 建立了 `LoggerConfig` 類別和 `get_logger()` 函數，提供統一的日誌配置介面。
        - 問題: 日誌檔案的組織和管理。
        - 解決方案: 按模組名稱和日期自動命名日誌檔案，並為錯誤日誌建立專用檔案。
    - **描述**: 提供一個簡單的 Web UI 方便使用者操作。
    - **完成情況**: 已完成基本功能及全面增強。
    - **已實現的增強功能**:
        - **全面的參數控制整合**: 使用者可直接在 UI 中配置所有 `.env` 中的關鍵參數，包括路徑設定、模型選擇、處理參數等，減少了對手動編輯配置檔案的依賴。
        - **即時進度顯示**: 為所有長時間執行的操作（如 LPIPS、超解析度、人臉偵測）提供即時進度條和狀態描述，提升使用者體驗。
        - **視覺化結果預覽**: 在人臉檢測、圖像裁切和圖像放大功能中新增了 Gallery 元件，使用者可以即時預覽處理結果的樣本圖像。
        - **整合式處理流程頁籤**: 新增了一個統一的處理流程介面，使用者可以選擇需要執行的處理步驟，設定相關參數，並一次性執行完整的預處理管線，類似於 `main.py` 的功能但更加直觀。
    - **遇到問題與解決方案**:
        - 問題: UI 的易用性和功能的全面性。
        - 解決方案: 採用分階段開發方式，逐步增強 UI 功能。使用 Gradio 的進階元件（如 Gallery、Progress、Accordion）提升使用者互動體驗。為每個功能提供清晰的說明和合理的預設值。

### 2.11. 完善的錯誤處理系統 (`error_handler.py`)
    - **描述**: 實現了統一的錯誤處理系統，提供專案範圍內一致的錯誤管理和友好的使用者提示。
    - **完成情況**: 已完成。
    - **已實現的功能**:
        - **統一異常定義**: 建立了繼承自 `WaifucError` 的專案自定義異常類別：
            - `DirectoryError`: 處理目錄相關錯誤（不存在、權限不足等）
            - `ImageProcessingError`: 處理圖像處理錯誤（格式不支援、圖像損壞等）
            - `ModelError`: 處理模型相關錯誤（載入失敗、CUDA 記憶體不足等）
            - `ConfigurationError`: 處理配置錯誤（環境變數錯誤等）
        - **安全執行包裝**: 實現了 `safe_execute()` 函數，為所有核心處理函數提供統一的錯誤捕獲和處理邏輯。
        - **全面模組整合**: 已完全整合到所有核心模組中：
            - `validate_image.py`: 增強圖像驗證的錯誤處理，包括權限檢查和詳細錯誤分類
            - `face_detection.py`: 改善人臉檢測的錯誤處理，區分模型錯誤和圖像處理錯誤
            - `lpips_clustering.py`: 強化 LPIPS 聚類的錯誤處理，提供批次處理錯誤恢復
            - `crop.py`: 優化圖像裁切的錯誤處理，包括 waifuc 模型和檔案操作錯誤
            - `upscale.py`: 完善圖像放大的錯誤處理，處理記憶體不足和模型執行錯誤
            - `tag.py`: 改善圖像標記的錯誤處理，區分模型錯誤和檔案 I/O 錯誤
        - **友好錯誤訊息**: 將技術性錯誤轉換為使用者可理解的說明，提供具體的解決建議。
        - **詳細日誌整合**: 與 `logger_config.py` 無縫整合，提供結構化的錯誤日誌記錄。
    - **遇到問題與解決方案**:
        - 問題: 如何在保持程式穩定性的同時提供詳細的錯誤資訊。
        - 解決方案: 實現了分層錯誤處理策略，使用 `safe_execute()` 包裝關鍵函數，確保單一處理失敗不會影響整個流程。
        - 問題: 不同類型錯誤的分類和處理策略。
        - 解決方案: 建立了清晰的異常類別層次結構，並在每個模組中針對特定錯誤類型提供專門的處理邏輯。
        - 問題: 平衡錯誤處理的完整性和程式碼的可讀性。
        - 解決方案: 採用統一的錯誤處理模式，所有模組使用相同的 `safe_execute()` 包裝函數，保持程式碼一致性。

### 2.12. 單元測試系統 (`tests/`)
    - **描述**: 建立了完整的單元測試框架，為核心模組提供自動化測試覆蓋，確保程式碼品質和穩定性。
    - **完成情況**: 已完成基礎框架，進行中的改進。
    - **測試統計** (截至2025年6月13日):
        - **測試總數**: 168個測試
        - **通過率**: 73.2% (123/168 通過)
        - **整體覆蓋率**: 30% (目標80%)
        - **測試文件**: 10個測試模組
    - **已完成的測試模組**:
        - **測試基礎設施** (`test_base.py`): 89%覆蓋率 ✅
            - 提供統一的測試環境設置和清理
            - 測試圖像生成和目錄結構管理
            - 測試輔助工具函數
        - **錯誤處理測試** (`test_error_handler.py`): 99%覆蓋率 ✅
            - 自定義異常類別測試 (WaifucError, DirectoryError, ImageProcessingError, ModelError, ConfigurationError)
            - safe_execute安全執行包裝函數測試
            - 錯誤訊息格式化和國際化測試
        - **圖像驗證測試** (`test_validate_image.py`): 72%覆蓋率 ✅
            - 單一圖像驗證功能測試
            - 批次圖像驗證和清理測試
            - 不同圖像格式相容性測試
            - 損壞圖像檢測能力測試
        - **LPIPS聚類測試** (`test_lpips_clustering.py`): 56%覆蓋率 ✅
            - 批次生成器測試
            - LPIPS相似度計算測試
            - 圖像聚類和去重邏輯測試
            - 大數據集處理模擬
    - **進行中的測試模組** (需要修復):
        - **日誌配置測試** (`test_logger_config.py`): 96%覆蓋率，6個測試失敗 ⚠️
            - 問題: 單例模式實現不一致，API命名問題
            - 需要修復: setup_logging vs setup_logger方法名稱統一
        - **人臉檢測測試** (`test_face_detection.py`): 1個CUDA相關測試失敗 ⚠️
            - 問題: CUDA記憶體錯誤模擬的異常類型不匹配
            - 大部分功能測試通過
        - **圖像標記測試** (`test_tag.py`): 5個測試失敗 ⚠️
            - 問題: 返回值格式與測試期望不匹配
            - 需要同步API變更
        - **圖像裁切測試** (`test_crop.py`): 5個測試失敗 ⚠️
            - 問題: 錯誤處理邏輯與實際實現不匹配
            - 部分Mock配置需要調整
        - **圖像放大測試** (`test_upscale.py`, `test_upscale_new.py`): 多個測試失敗 ⚠️
            - 問題: Mock設置不正確，PIL Image上下文管理器問題
            - ThreadPoolExecutor導入路徑錯誤
    - **測試覆蓋率詳細統計**:
        - 高覆蓋率模組: error_handler (99%), logger_config (96%), validate_image (72%)
        - 中等覆蓋率模組: lpips_clustering (56%)
        - 待改進模組: crop, face_detection, tag, upscale, main, gradio_app (0%覆蓋率)
    - **遇到問題與解決方案**:
        - 問題: Mock配置複雜度高，特別是涉及第三方庫和上下文管理器的測試。
        - 解決方案: 建立統一的測試基礎設施，提供常用Mock模式的封裝。
        - 問題: API變更導致測試失敗。
        - 解決方案: 建立持續集成流程，確保代碼變更時及時更新測試。
        - 問題: 測試環境隔離和清理。
        - 解決方案: 使用tempfile建立隔離的測試環境，setUp和tearDown確保環境清潔。
    - **下一步工作**:
        - [ ] 修復45個失敗的測試
        - [ ] 提升整體測試覆蓋率至80%以上
        - [ ] 添加集成測試和端到端測試
        - [ ] 建立自動化CI/CD管道

## 3. 遇到的主要挑戰與解決方案

*   **效能問題**: 許多圖像處理步驟（尤其是 LPIPS、超解析度、人臉偵測）在大量圖像上執行緩慢。
    *   **解決方案**:
        *   引入批次處理。
        *   允許使用者透過設定跳過某些步驟或設定處理閾值（如 `min_size` for upscale）。
        *   提示使用者 ONNX Runtime-GPU 版本以利用 GPU 加速。
        *   未來考慮：非同步處理、更高效的演算法選擇、分散式處理。

*   **依賴管理**: 專案依賴多個外部庫，版本相容性可能成為問題。
    *   **解決方案**: 使用 `requirements.txt` 明確版本。未來可考慮 `poetry` 或 `conda` 等更強大的環境管理工具。

*   **設定的靈活性與易用性**: 如何平衡功能的強大性與使用者設定的簡便性。
    *   **解決方案**: 使用 `.env` 檔案進行配置，提供合理的預設值。Gradio UI 有助於降低使用門檻。

*   **錯誤處理與日誌**: 確保在處理過程中發生錯誤時，能提供清晰的錯誤訊息和日誌。
    *   **解決方案**: 在 `main.py` 和各模組中加入了基本的 `try-except` 結構和 `print` 日誌。未來可考慮使用 Python 的 `logging` 模組實現更結構化的日誌記錄。

## 4. 未來工作與改進方向

*   **效能優化**:
    *   探索更快的替代演算法。
    *   針對特定硬體（如 NVIDIA GPU）進行更深度的優化。
*   **擴展性**:
    *   允許使用者更容易地整合自訂的處理模組或模型。
    *   支援更多圖像格式和模型類型。
*   **使用者介面改進**:
    *   Gradio UI 功能增強，例如更細緻的參數調整。
    *   考慮使用更專業的 GUI 框架（如 Qt）或 Web 框架（如 Flask/Django）開發更成熟的應用程式。
*   **測試**: 持續增加單元測試和整合測試，確保程式碼品質和功能穩定性。
*   **文件**: 持續更新 `README.md` 和 `spec.md`，增加更詳細的使用者指南和開發者文件。

## 5. 結論

目前專案已成功實現了核心的自動化圖像預處理功能，為動漫風格 AI 模型訓練提供了有力的工具。透過模組化設計和環境變數配置，專案具有一定的靈活性和可擴展性。未來將持續關注效能優化、易用性提升和功能擴展。
