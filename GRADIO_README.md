# Gradio 整合使用說明

本專案已成功整合 Gradio 網頁介面，提供直觀的圖片處理工具操作體驗。

## 🚀 快速開始

### 1. 安裝依賴

確保已安裝所有必要的依賴套件：

```bash
pip install -r requirements.txt
```

### 2. 設定環境變數

複製 `.env_sample` 為 `.env` 並設定相關參數：

```bash
cp .env_sample .env
```

編輯 `.env` 檔案，設定預設的目錄路徑和其他參數。

### 3. 啟動 Gradio 介面

```bash
python gradio_app.py
```

啟動後，開啟瀏覽器訪問 `http://localhost:7860` 即可使用網頁介面。

## 📋 功能說明

### 🔄 完整流程標籤

提供一站式的圖片處理流程，包含：

- **📁 目錄選擇**: 指定要處理的圖片目錄
- **🛠️ 步驟選擇**: 可選擇執行的處理步驟
  - ✅ 驗證圖片：移除損壞的圖片檔案
  - 🔍 透明度處理：轉換透明背景為白色
  - 👤 人臉偵測：篩選特定人臉數量的圖片
  - 🔄 圖片去重複：使用 LPIPS 找出相似圖片
  - ✂️ 裁切與分類：自動裁切並分類圖片
  - 🏷️ 圖片標記：自動產生描述標籤
- **📈 圖片放大**: 可選的超解析度處理
- **🔧 進階設定**: 細部參數調整

### 🔧 單元功能標籤

提供獨立的功能模組操作：

#### ✅ 圖片驗證
- 掃描並移除損壞或不完整的圖片檔案
- 顯示處理統計資訊

#### 🔍 透明度處理
- **掃描功能**: 檢查目錄中哪些圖片包含透明通道
- **轉換功能**: 將透明背景轉換為白色背景
- 提供詳細的掃描結果表格

#### 👤 人臉偵測
- 設定最小人臉數量閾值
- 將符合條件的圖片移動到分類資料夾
- 按人臉數量自動建立子資料夾

#### 🔄 圖片去重複
- 使用 LPIPS 演算法進行相似度分析
- 可調整批次大小和相似度閾值
- 將相似圖片群組化處理

#### ✂️ 圖片裁切與分類
- 自動裁切人物圖像
- 分類為頭像、半身、全身等類別
- 統計各類別的圖片數量

#### 🏷️ 圖片標記
- 自動產生圖片描述標籤
- 支援自定義角色和藝術家設定
- 支援 wildcard 功能

## 🔧 技術細節

### 程式碼架構

1. **main.py**: 包含 `run_full_pipeline()` 函式，執行完整處理流程
2. **各功能模組**: 已重構為可獨立呼叫的函式
   - `validate_image.py`: 圖片驗證功能
   - `transparency.py`: 透明度處理功能
   - `face_detection.py`: 人臉偵測功能
   - `lpips_clustering.py`: 圖片去重複功能
   - `crop.py`: 裁切與分類功能
   - `upscale.py`: 圖片放大功能
   - `tag.py`: 圖片標記功能
3. **gradio_app.py**: Gradio 網頁介面主程式

### 函式介面統一化

所有處理函式都返回統一的字典格式：

```python
{
    'success': bool,           # 是否成功
    'logs': str,              # 處理日誌
    'error': str or None,     # 錯誤訊息
    'summary': dict           # 處理摘要統計
}
```

### 錯誤處理

- 完整的輸入驗證
- 詳細的錯誤訊息回饋
- 處理過程日誌記錄
- 異常情況的安全處理

## 🎯 使用建議

1. **備份重要資料**: 處理前請先備份原始圖片
2. **測試小量資料**: 建議先用少量圖片測試設定
3. **合理設定參數**: 根據硬體效能調整批次大小等參數
4. **監控處理過程**: 關注日誌輸出，及時發現問題
5. **分步驟處理**: 對於大量資料，可以分別執行各個步驟

## 🐛 故障排除

### 常見問題

1. **依賴套件缺失**: 確保已安裝 `requirements.txt` 中的所有套件
2. **記憶體不足**: 調整批次大小參數，或處理較少的圖片
3. **目錄權限問題**: 確保有讀寫目錄的權限
4. **GPU 相關錯誤**: 檢查 CUDA 和相關驅動是否正確安裝

### 除錯方法

1. 查看 Gradio 介面中的日誌輸出
2. 檢查終端機的錯誤訊息
3. 驗證輸入目錄和檔案是否存在
4. 測試個別功能模組是否正常運作

## 📞 技術支援

如遇到問題，請：

1. 檢查本說明文件
2. 查看原始程式碼中的註解
3. 確認環境設定是否正確
4. 提供詳細的錯誤訊息和使用情境

---

**享受使用 Waifuc 圖片處理工具箱！** 🎉