# 任務清單與進度追蹤

## 核心功能 (已完成)

- [x] **環境設定與依賴管理**
    - [x] 初始化專案結構
    - [x] 建立 `requirements.txt`
- [x] **圖像驗證模組 (`validate_image.py`)**
    - [x] 實現圖像完整性檢查
    - [x] 移除損壞檔案
- [x] **人臉偵測模組 (`face_detection.py`)**
    - [x] 整合人臉偵測模型
    - [x] 根據人臉數量篩選圖像
    - [x] 輸出到指定目錄
- [x] **圖像去重複模組 (`lpips_clustering.py`)**
    - [x] 實現 LPIPS 相似度計算
    - [x] 實現圖像聚類或基於閾值的去重
    - [x] 批次處理以優化效能
- [x] **圖像裁切與分類模組 (`crop.py`)**
    - [x] 實現多規格圖像裁切 (全身、半身、頭像)
    - [x] 將裁切後的圖像分類到不同資料夾
- [x] **圖像放大模組 (`upscale.py`)**
    - [x] 整合超解析度模型
    - [x] 允許設定目標尺寸和模型
    - [x] 允許設定最小處理尺寸以跳過大圖
- [x] **圖像標記模組 (`tag.py`)**
    - [x] 整合自動圖像標記模型
    - [x] 將標籤儲存到檔案
- [x] **主流程控制 (`main.py`)**
    - [x] 實現主執行邏輯
    - [x] 透過 `.env` 檔案讀取和應用設定
    - [x] 協調各模組執行順序
- [x] **(推測) Gradio UI 介面 (`gradio_app.py`)**
    - [x] 建立基本的使用者介面

## 待辦事項 / 未來改進

### 高優先級
- [x] **Gradio UI 增強 (已完成)**
    - [x] **全面的參數控制整合**: 允許使用者在 UI 中調整所有 `.env` 中的關鍵參數。
        - [x] 識別 `.env` 中的所有相關參數。
        - [x] 為每個模組頁籤新增 Gradio 輸入元件。
        - [x] 設定清晰標籤和預設值。
        - [x] 修改後端函數以接收 UI 輸入。    
    - [x] **即時進度顯示**: 為長時間執行的操作提供狀態回饋。
        - [x] 研究並實作 Gradio 進度元件。
        - [x] 調整核心函數以產生進度更新。
        - [x] 在 UI 中動態顯示進度。    
    - [x] **視覺化結果預覽**: 即時查看圖像處理結果。
        - [x] 在相關頁籤新增 `gr.Image` 或 `gr.Gallery`。
        - [x] 修改後端函數以回傳範例輸出圖像路徑。
        - [x] 在 UI 中顯示範例圖像。    
    - [x] **整合式處理流程頁籤**: 提供統一介面執行完整處理序列。
        - [x] 建立「完整流程」頁籤。
        - [x] 新增各處理階段的選擇控制項。
        - [x] 實作順序執行邏輯與參數管理。
        - [x] 顯示整體進度和報告。
- [x] **詳細日誌系統**
    - [x] 引入 Python `logging` 模組
    - [x] 設定不同日誌級別 (DEBUG, INFO, WARNING, ERROR)
    - [x] 可選將日誌輸出到檔案
- [x] **完善的錯誤處理**
    - [x] 建立統一的錯誤處理系統 (`error_handler.py`)
        - [x] 定義專案自定義異常類別 (WaifucError, DirectoryError, ImageProcessingError, ModelError, ConfigurationError)
        - [x] 實現 `safe_execute` 安全執行包裝函數
        - [x] 提供友好的錯誤訊息與詳細的日誌記錄
    - [x] 整合錯誤處理到所有核心模組
        - [x] `validate_image.py` - 圖像驗證模組錯誤處理整合
        - [x] `face_detection.py` - 人臉檢測模組錯誤處理整合
        - [x] `lpips_clustering.py` - 圖像去重複模組錯誤處理整合
        - [x] `crop.py` - 圖像裁切與分類模組錯誤處理整合
        - [x] `upscale.py` - 圖像放大模組錯誤處理整合
        - [x] `tag.py` - 圖像標記模組錯誤處理整合
    - [x] 針對各類型錯誤提供友好的使用者提示
        - [x] IO 錯誤 (檔案不存在、權限不足等)
        - [x] 模型錯誤 (模型載入失敗、CUDA 記憶體不足等)
        - [x] 配置錯誤 (環境變數設定錯誤等)
        - [x] 圖像處理錯誤 (格式不支援、圖像損壞等)
- [x] **撰寫單元測試** *(已完成 - 100% 通過率)*
    - [x] 為核心模組的關鍵函式編寫單元測試 *(已完成10個測試文件)*
    - [x] 實現測試基礎設施和輔助工具 (`test_base.py`)
    - [x] 錯誤處理模組測試 (`test_error_handler.py`) - 100% 通過率 ✅
    - [x] 圖像驗證模組測試 (`test_validate_image.py`) - 100% 通過率 ✅
    - [x] LPIPS聚類模組測試 (`test_lpips_clustering.py`) - 100% 通過率 ✅
    - [x] 日誌配置模組測試 (`test_logger_config.py`) - 100% 通過率 ✅
    - [x] 人臉檢測模組測試 (`test_face_detection.py`) - 100% 通過率 ✅
    - [x] 圖像標記模組測試 (`test_tag.py`) - 100% 通過率 ✅
    - [x] 圖像裁切模組測試 (`test_crop.py`) - 100% 通過率 ✅
    - [x] 圖像放大模組測試 (`test_upscale.py`) - 100% 通過率 ✅
    - [x] **所有測試問題已修復**:
        - [x] 修復logger_config單例模式測試
        - [x] 修復upscale模組的Mock配置
        - [x] 修復tag模組的返回值格式
        - [x] 修復crop模組的錯誤處理邏輯
        - [x] 達到100%測試通過率 🎉
    - [x] 確保程式碼變更後的穩定性 *(已建立完整的測試覆蓋)*

### 中優先級
- [ ] **效能分析與優化**
    - [ ] 分析各模組的效能瓶頸 (如使用 cProfile)
    - [ ] 針對瓶頸進行優化 (例如，LPIPS 的 GPU 加速驗證，人臉偵測模型的選擇)
- [ ] **使用者文件完善**
    - [ ] 更新 `README.md`，包含更詳細的安裝、設定和使用步驟
    - [ ] 為 `.env` 中的每個參數提供清晰的說明
- [ ] **可配置的相似度/信心度閾值**
    - [ ] 允許使用者在 `.env` 或 UI 中設定 LPIPS 去重閾值
    - [ ] 允許使用者設定人臉偵測的信心度閾值 (如果模型支援)
- [ ] **支援更多超解析度模型**
    - [ ] 研究並整合其他流行的超解析度模型
    - [ ] 允許使用者透過設定選擇不同的模型

### 低優先級
- [ ] **非同步處理/多執行緒**
    - [ ] 對於 IO 密集型或可並行的任務，考慮使用 `asyncio` 或 `concurrent.futures` 進一步提升效能
- [ ] **整合更進階的依賴管理工具**
    - [ ] 考慮使用 `Poetry` 或 `Conda` 進行環境和依賴管理
- [ ] **打包成可執行檔**
    - [ ] 研究使用 `PyInstaller` 或類似工具將專案打包，方便無 Python 環境的使用者
- [ ] **支援雲端儲存**
    - [ ] 整合 Boto3 (已在 `requirements.txt` 中) 以支援從 S3 等雲端儲存讀取/寫入圖像
- [ ] **擴展圖像標記功能**
    - [ ] 支援更多標記模型或自訂標記詞典

## 已知問題 / 注意事項
- LPIPS 和超解析度計算資源消耗較大，處理大量圖像時可能需要較長時間。
- 部分功能依賴 `waifuc` 和 `imgutils` 庫，其內部實現和模型更新可能會影響專案行為。
- 當前錯誤處理和日誌記錄相對簡單。
